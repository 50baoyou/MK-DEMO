# 配置数据持久化功能并测试后端接口

## 数据持久化

利用redux-persist进行状态管理的持久化处理。

并且对state和dispatch进行类型限定。

```typescript
import { configureStore } from '@reduxjs/toolkit'
import type { Reducer, AnyAction } from '@reduxjs/toolkit'
import usersReducer from './modules/users'
import type { UsersState } from './modules/users'
import type { PersistPartial } from 'redux-persist/es/persistReducer'
import {
  persistStore,
  persistReducer,
} from 'redux-persist'
import storage from 'redux-persist/lib/storage'
import { useDispatch } from 'react-redux'
const persistConfig = {
  key: 'root',
  version: 1,
  storage,
  whitelist: ['token']
}
const store = configureStore({
  reducer: {
    users: persistReducer(persistConfig, usersReducer) as Reducer<UsersState & PersistPartial, AnyAction>
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: false
    }),
})
persistStore(store)
export type RootState = ReturnType<typeof store.getState>
export type AppDispatch = typeof store.dispatch
export const useAppDispatch: () => AppDispatch = useDispatch
export default store;
```

如何使用定义的RootState和useAppDispatch呢？

下面是登录页的逻辑实现。

```tsx
import React from 'react'
import styles from './Login.module.scss'
import { Button, message } from 'antd'
import { useSelector } from 'react-redux'
import { useAppDispatch } from '../../store'
import type { RootState } from '../../store'
import { loginAction, updateToken } from '../../store/modules/users'
export default function Login() {
  const token = useSelector((state: RootState)=> state.users.token)
  const dispatch = useAppDispatch()
  const handleLogin = () => {
    dispatch(loginAction({ email: 'huangrong@imooc.com', pass: 'huangrong' })).then((action)=>{
      const {errcode, token} = (action.payload as {[index: string]: unknown}).data as {[index: string]: unknown}
      if( errcode === 0 && typeof token === 'string' ){
        dispatch(updateToken(token))
        message.success('登录成功');
      }
      else{
        message.error('登录失败');
      }
    })
  }
  return (
    <div>
      Login
      <br />
      <Button onClick={handleLogin}>登录</Button>
      { token }
    </div>
  )
}
```

最后进行测试，并完成本章的整体架构，提交git。

