# 添加路由权限及登录拦截

## 添加元信息

上一个小节中，完成了用户身份的校验，那么接下来就对指定的页面进行判断了。这时可以给不同的页面添加不同的元信息，利用路由配置表。

```typescript
// /router/index.ts
declare module 'react-router' {
  interface IndexRouteObject {
    meta?: {
      menu?: boolean
      title?: string
      icon?: React.ReactNode 
      auth?: boolean
    },
    name?: string
  }
  interface NonIndexRouteObject {
    meta?: {
      menu?: boolean
      title?: string
      icon?: React.ReactNode  
      auth?: boolean
    },
    name?: string
  }
}
export const routes: RouteObject[] = [
  {
    path: '/',
    element: React.createElement(Navigate, {to: '/sign'})
  },
  {
    path: '/',
    name: 'home',
    element: React.createElement(BeforeEach, null, React.createElement(Home)),
    meta: {
      menu: true,
      title: '考勤管理',
      icon: React.createElement(CopyOutlined),
      auth: true
    },
    children: [
      {
        path: 'sign',
        name: 'sign',
        element: React.createElement(Sign),
        meta: {
          menu: true,
          title: '在线打卡签到',
          icon: React.createElement(CalendarOutlined),
          auth: true
        }
      },
      {
        path: 'exception',
        name: 'exception',
        element: React.createElement(Exception),
        meta: {
          menu: true,
          title: '异常考勤查询',
          icon: React.createElement(WarningOutlined),
          auth: true,
        }
      },
      {
        path: 'apply',
        name: 'apply',
        element: React.createElement(Apply),
        meta: {
          menu: true,
          title: '添加考勤审批',
          icon: React.createElement(FileAddOutlined),
          auth: true,
        }
      },
      {
        path: 'check',
        name: 'check',
        element: React.createElement(Check),
        meta: {
          menu: true,
          title: '我的考勤审批',
          icon: React.createElement(ScheduleOutlined),
          auth: true,
        }
      }
    ]
  },
  {
    path: '/login',
    element: React.createElement(BeforeEach, null, React.createElement(Login))
  }
];
```

接下来就是在`<BeforeEach>`组件中进行最后的完整判断条件，从而实现拦截。

```typescript
// /components/BeforeEach/BeforeEach.tsx
import React from 'react'
import { useLocation, matchRoutes, Navigate } from 'react-router-dom'
import { routes } from '../../router'
import { useAppDispatch } from '../../store'
import { infosAction, updateInfos } from '../../store/modules/users'
import type { Infos } from '../../store/modules/users'
import { useSelector } from 'react-redux'
import type { RootState } from '../../store'
import _ from 'lodash'
interface BeforeEachProps {
  children?: React.ReactNode
}
export default function BeforeEach(props: BeforeEachProps) {
  const token = useSelector((state: RootState)=> state.users.token)
  const infos = useSelector((state: RootState)=> state.users.infos)
  const dispatch = useAppDispatch()
  const location = useLocation()
  const matchs = matchRoutes(routes, location)
  if( Array.isArray(matchs) ){
    const meta = matchs[matchs.length-1].route.meta
    if(meta?.auth && _.isEmpty(infos) ){
      if(token){
        dispatch(infosAction()).then((action)=>{
          const {errcode, infos} = (action.payload as {[index: string]: unknown}).data as {[index: string]: unknown}
          if(errcode === 0){
            dispatch(updateInfos(infos as Infos))
          }
        })
      }
      else{
        return <Navigate to="/login" />
      }
    }
  }
  if( token && location.pathname === '/login' ){
    return <Navigate to="/" />
  }
  return (
    <>{ props.children }</>
  )
}
```

