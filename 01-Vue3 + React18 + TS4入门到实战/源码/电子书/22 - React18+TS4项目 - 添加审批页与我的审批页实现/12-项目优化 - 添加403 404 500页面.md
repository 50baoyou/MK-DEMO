# 项目优化 - 添加403 404 500页面

先完成403 404 500页面的布局，分别为`/views/NotAuth/NotAuth.tsx`、`/views/NotFound/NotFound.tsx`、`/views/NotServer/NotServer.tsx`

下面以NotAuth.tsx文件为例，看一下布局和样式。

```tsx
import React from 'react'
import img403 from '../../assets/images/403.png'
import { Link } from 'react-router-dom'
import { Button } from 'antd'
export default function NotAuth() {
  return (
    <div className="status-wrapper">
      <img src={img403} alt="" />
      <p>没有权限</p>
      <Link to="/">
        <Button type="primary">回到首页</Button>
      </Link>
    </div>
  )
}
```

全局样式`/assets/styles/common.scss`

```scss
.status-wrapper{
    margin: 20px auto;
    width: 315px;
    text-align: center;
    p{
        margin: 30px 0;
    }
}
```

接下来就是配置路由信息了，代码如下：

```typescript
export const routes: RouteObject[] = [
  {
    path: '/403',
    element: React.createElement(NotAuth)
  },
  {
    path: '/404',
    element: React.createElement(NotFound)
  },
  {
    path: '/500',
    element: React.createElement(NotServer)
  },
  {
    path: '*',
    element: React.createElement(Navigate, {to: '/404'})
  }
];
```

在路由表的最后完成404的功能，那么403没有权限，我们需要在全局守卫<BeforeEach>组件中来完成。

```tsx
export default function BeforeEach(props: BeforeEachProps) {
  const token = useSelector((state: RootState)=> state.users.token)
  const infos = useSelector((state: RootState)=> state.users.infos)
  const dispatch = useAppDispatch()
  const location = useLocation()
  const matchs = matchRoutes(routes, location)
  if( Array.isArray(matchs) ){
    const meta = matchs[matchs.length-1].route.meta
    const name = matchs[matchs.length-1].route.name
    if(meta?.auth && _.isEmpty(infos) ){
      if(token){
        dispatch(infosAction()).then((action)=>{
          const {errcode, infos} = (action.payload as {[index: string]: unknown}).data as {[index: string]: unknown}
          if(errcode === 0){
            dispatch(updateInfos(infos as Infos))
          }
        })
      }
      else{
        return <Navigate to="/login" />
      }
    }
    else if( Array.isArray(infos.permission) && !infos.permission.includes(name) ){
      return <Navigate to="/403" />
    }
  }
  if( token && location.pathname === '/login' ){
    return <Navigate to="/" />
  }
  return (
    <>{ props.children }</>
  )
}
```

最后500的功能，可以在http.ts的响应拦截器中统一的进行处理。

```typescript
// /src/utils/http.ts
import router from '../router';
instance.interceptors.response.use(function (response) {
  if(response.data.errmsg === 'token error'){
    message.error('token error')
    store.dispatch(clearToken())
    setTimeout(()=>{
      window.location.replace('/login')
    }, 1000)
  }
  else if(response.data.errmsg === 'error'){
    router.navigate('/500');
  }
  return response;
}, function (error) {
  return Promise.reject(error);
});
```

