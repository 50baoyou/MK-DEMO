# 状态管理用户打卡信息

## 定义签到页数据

前面已经完成了签到页的布局，本小节要通过状态管理的控制数据的渲染操作。

首先需要编写签到页对应的状态管理文件。

```typescript
// /store/modules/signs.ts
import http from '../../utils/http';
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit'
import type { PayloadAction } from '@reduxjs/toolkit'
export type Infos = {
  [index: string]: unknown
}
export type SignsState = {
  infos: Infos
}
type Time = {
  userid: string
}
export const getTimeAction = createAsyncThunk('signs/getTimeAction', async (payload: Time) => {
  const ret = await http.get('/signs/time', payload)
  return ret;
})
export const putTimeAction = createAsyncThunk('signs/putTimeAction', async (payload: Time)=>{
  const ret = await http.put('/signs/time', payload)
  return ret; 
})
const signsSlice = createSlice({
  name: 'signs',
  initialState: {
    infos: {}
  } as SignsState,
  reducers: {
    updateInfos(state, action: PayloadAction<Infos>){
      state.infos = action.payload;
    }
  }
})
export const { updateInfos } = signsSlice.actions;
export default signsSlice.reducer;
```

## 调用签到页数据

编写好了对应的状态管理后，就可以在界面中进行调用。

```tsx
// /views/Sign/Sign.tsx
import React, { useState, useEffect } from 'react'
import styles from './Sign.module.scss'
import {
    Descriptions,
    Button,
    Tag,
    Calendar,
    Row,
    Space,
    Select,
    message,
} from 'antd'
import 'dayjs/locale/zh-cn'
import locale from 'antd/es/date-picker/locale/zh_CN'
import type { Dayjs } from 'dayjs'
import { useNavigate } from 'react-router-dom'
import { useSelector } from 'react-redux'
import { useAppDispatch } from '../../store'
import type { RootState } from '../../store'
import _ from 'lodash'
import {
    getTimeAction,
    putTimeAction,
    updateInfos,
} from '../../store/modules/signs'
import type { Infos } from '../../store/modules/signs'
import { toZero } from '../../utils/common'

const date = new Date()

enum DetailKey {
    normal = '正常出勤',
    absent = '旷工',
    miss = '漏打卡',
    late = '迟到',
    early = '早退',
    lateAndEarly = '迟到并早退',
}

const originDetailValue: Record<keyof typeof DetailKey, number> = {
    normal: 0,
    absent: 0,
    miss: 0,
    late: 0,
    early: 0,
    lateAndEarly: 0,
}

const originDetailState = {
    type: 'success' as 'success' | 'error',
    text: '正常' as '正常' | '异常',
}

export default function Sign() {
    const [month, setMonth] = useState(date.getMonth())
    const navigate = useNavigate()
    const signsInfos = useSelector((state: RootState) => state.signs.infos)
    const usersInfos = useSelector((state: RootState) => state.users.infos)
    const dispatch = useAppDispatch()
    useEffect(() => {
        if (_.isEmpty(signsInfos)) {
            dispatch(getTimeAction({ userid: usersInfos._id as string })).then(
                (action) => {
                    const { errcode, infos } = (
                        action.payload as { [index: string]: unknown }
                    ).data as { [index: string]: unknown }
                    if (errcode === 0) {
                        dispatch(updateInfos(infos as Infos))
                    }
                }
            )
        }
    }, [signsInfos, usersInfos, dispatch])
    
    return (
        <div>
            ...
        </div>
    )
}
```

